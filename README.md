# Azure RTOS ThreadX running on STM32F429IGTx

This is a CMake project using code generated by STM32CubeMX and Azure RTOS ThreadX.

##Build and flash

To build and run the project requires `cmake` and `openOCD`.

1) use STM32CubeMX to configure pins and generate code.

2) generate build tree, run the following command under project root:

```bash
$ cmake -Bbuild -DCMAKE_BUILD_TYPE=Debug -GNinja
```

3) build, run the following command under project root:

```bash
$ cmake --build ./build --target stm32f429CubeThreadXTest.elf
```

4) flash, run the following command under project root:
```bash
$ openocd -f stm32f429igt_dev.cfg -c "program build/stm32f429CubeThreadXTest.elf" -c reset -c shutdown
```

##Modify

The project is configured to run on a custom STM32F429IGTx board. To make it run on other stm32f4 series device, the following steps should be taken:

1) remove file `.cproject` `.mxproject` `.project` `stm32f429CubeThreadXTest.ioc` `stm32f429igt_dev.cfg` `STM32F429IGTX_FLASH.ld` `STM32F429IGTX_RAM.ld`.
   
2) remove folder `Core` `Drivers`.
   
3) generate new files using STM32CubeMX with the appropriate configuration. Remember to select the "generate under root" option under the Project Manager tag.
   
4) modify `CMakeLists.txt`:
   1) change `STM32F429xx` in line `86`: `add_definitions(-DUSE_HAL_DRIVER -DDEBUG -DSTM32F429xx)` to the chip name of the current device.
   2) change `STM32F429IGTX_FLASH.ld` in line `95`: `set(LINKER_SCRIPT ${CMAKE_SOURCE_DIR}/STM32F429IGTX_FLASH.ld)` to the name of the current linker script i.e. `.ld` file.
   3) remove or comment out the "Include threadx library" section from lien `60` to `74`.

5) move folder `User/threadXPort` to the project root so files it contains will not be compiled.

6) compile, flash and test the program with the appropriate `.cfg` file (used by openOCD) to make sure everything is working properly without ThreadX.

7) move folder `threadXPort` back into `User`.

8) add the "Include threadx library" section back to `CMakeLists.txt` then remove folder `build` and regenerate the build tree.

9) modify the while loop in `void my_thread_entry(ULONG thread_input)` in file `User/threadXPort/tx_application_define.c` to whatever you wish.

10) add `__RAM_segment_used_end__ = .;` to the end of the `_user_heap_stack` section of the linker script i.e. the `.ld` file. For example:
```ld
/* User_heap_stack section, used to check that there is enough "RAM" Ram  type memory left */
  ._user_heap_stack :
  {
    . = ALIGN(8);
    PROVIDE ( end = . );
    PROVIDE ( _end = . );
    . = . + _Min_Heap_Size;
    . = . + _Min_Stack_Size;
    . = ALIGN(8);
    __RAM_segment_used_end__ = .;
  } >RAM
```

11) remove or use `#if 0 ... #endif` to disable function definition of `void PendSV_Handler(void)` `void SysTick_Handler(void)` from newly generated file `Core/Src/stm32f4xx_it.c`.

12) change `SYSTEM_CLOCK` in `User/threadXPort/tx_initialize_low_level.S` to the clock speed of the current device.

13) in `Core/Src/main.c` include header file `tx_api.h` from ThreadX. Then call function `_tx_initialize_kernel_enter()` or macro `tx_kernel_enter()` in `main()` before the while loop.

14) ThreadX should be now running.


##Notes

Even though the project contains STM32CubeIDE project files, this project is <b>NOT</b> developed using STM32CubeIDE.
So trying to compile this project with STM32CubeIDE will fail for sure.

This project is developed using CLion. Its project files are also contained.
